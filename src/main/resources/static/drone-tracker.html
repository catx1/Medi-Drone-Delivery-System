<!DOCTYPE html>
<html>
<head>
    <title>MediDrone - Medication Delivery</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            padding: 20px 0 30px 0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .section-title {
            font-size: 1.4em;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        /* Order Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Map Container with Center Pin */
        .map-container {
            position: relative;
            height: 600px;
            border-radius: 15px;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Center Pin Overlay */
        .center-pin {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            z-index: 1000;
            pointer-events: none;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .center-pin img {
            width: 41px;
            height: 41px;
        }

        /* Address Display */
        .address-display {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999;
            font-weight: 600;
            color: #333;
            max-width: 80%;
            text-align: center;
        }

        /* Order Status Styles */
        .order-status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .status-queued { background: #ffc107; color: #000; }
        .status-in-transit { background: #2196F3; color: white; }
        .status-arrived { background: #4CAF50; color: white; }
        .status-collected { background: #9E9E9E; color: white; }


        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            width: 0%;
        }

        .hidden {
            display: none !important;
        }

        .info-text {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .step-indicator {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 4px;
            color: #1976d2;
            font-weight: 500;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>üöÅ MediDrone</h1>
        <p>Fast, Reliable Medication Delivery by Drone</p>
    </div>

    <div class="main-content">
        <!-- Left Panel: Order Form -->
        <div class="card">
            <h2 class="section-title">Place Your Order</h2>

            <!-- Order Form (visible by default) -->
            <div id="orderFormSection">
                <!-- Step 1: Enter Address -->
                <div id="step1" class="step">
                    <div class="step-indicator">
                        Step 1: Enter Your Address
                    </div>

                    <div class="form-group">
                        <label for="address">Delivery Address</label>
                        <input type="text" id="address"
                               placeholder="e.g., 10 George Square, Edinburgh"
                               onkeypress="if(event.key === 'Enter') geocodeAddress()">
                        <p class="info-text">
                            We'll place a pin you can adjust for the exact pickup spot
                        </p>
                    </div>

                    <button class="btn" onclick="geocodeAddress()">
                        Find Location
                    </button>
                </div>

                <!-- Step 2: Select Medication (hidden initially) -->
                <div id="step2" class="step hidden">
                    <div class="step-indicator">
                        Step 2: Select Medication
                    </div>

                    <div class="form-group">
                        <label for="medication">Medication</label>
                        <select id="medication">
                            <option value="">Loading medications...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="quantity">Quantity</label>
                        <input type="number" id="quantity" value="1" min="1" max="10">
                    </div>

                    <button class="btn" onclick="placeOrder()">Place Order</button>
                    <button class="btn" onclick="backToStep1()"
                            style="margin-top: 10px; background: #6c757d;">
                        Change Location
                    </button>
                </div>
            </div>

            <!-- Order Status (hidden initially) -->
            <div id="orderStatusSection" class="hidden">
                <div class="status-badge" id="statusBadge">QUEUED</div>

                <div style="margin-bottom: 15px;">
                    <strong>Order Number:</strong>
                    <div id="orderNumber" style="font-size: 1.2em; margin: 5px 0; color: #667eea;"></div>
                </div>



                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>

                <div id="statusMessage" style="margin: 15px 0; color: #666; text-align: center;"></div>

                <!-- Confirm Pickup Section (shown when arrived) -->
                <div id="confirmPickupSection" class="hidden">
                    <button class="btn" onclick="confirmPickup()"
                            style="width: 100%; padding: 15px; font-size: 1.1em; background: #4CAF50;">
                        ‚úì Order Collected
                    </button>
                    <small style="display: block; text-align: center; margin-top: 10px; color: #666;">
                        Click this button after collection is confirmed
                    </small>
                </div>

                <button class="btn" onclick="resetOrder()"
                        style="margin-top: 15px; background: #6c757d;">
                    Place New Order
                </button>
            </div>
        </div>

        <!-- Right Panel: Map with Center Pin -->
        <div class="card">
            <h2 class="section-title">Delivery Location</h2>
            <div class="map-container">
                <div id="map"></div>

                <!-- Center Pin (Red Marker) -->
                <div class="center-pin" id="centerPin">
                    <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png" alt="pin">
                </div>

                <!-- Address Display -->
                <div class="address-display" id="addressDisplay">
                    Move map to select location
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let map, droneMarker, deliveryMarker, servicePointMarker, startMarker, flightPathLine;
    let stompClient = null;
    let currentOrderNumber = null;
    let selectedLat = null;
    let selectedLng = null;
    let selectedAddress = null;

    // Initialize map centered on Edinburgh
    map = L.map('map').setView([55.9445, -3.1892], 14);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a> contributors'
    }).addTo(map);

    // Add Appleton Tower (base) marker
    startMarker = L.marker([55.9445, -3.1892], {
        icon: L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41]
        })
    }).addTo(map).bindPopup("Appleton Tower (Base)");

    // Load medications on page load
    loadMedications();

    // Connect WebSocket automatically
    connectWebSocket();

    // ===== FUNCTIONS =====

    function loadMedications() {
        fetch('/api/v1/orders/medications')
            .then(r => r.json())
            .then(meds => {
                const select = document.getElementById('medication');
                select.innerHTML = '<option value="">Select medication...</option>';
                meds.forEach(med => {
                    const option = document.createElement('option');
                    option.value = med.id;
                    option.textContent = `${med.name} - ${med.description} (${med.stockQuantity} in stock)`;
                    select.appendChild(option);
                });
            })
            .catch(err => {
                console.error('Failed to load medications:', err);
            });
    }

    function geocodeAddress() {
        const address = document.getElementById('address').value;

        if (!address) {
            alert('Please enter an address');
            return;
        }

        // Show loading
        document.getElementById('addressDisplay').textContent = 'Finding location...';

        // Use your backend geocoding service
        fetch(`/api/v1/drone/test-geocoding?address=${encodeURIComponent(address)}`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    selectedLat = data.coordinates.lat;
                    selectedLng = data.coordinates.lng;
                    selectedAddress = address;

                    // Remove old delivery marker if exists
                    if (deliveryMarker) {
                        map.removeLayer(deliveryMarker);
                    }

                    // Create DRAGGABLE delivery marker
                    deliveryMarker = L.marker([selectedLat, selectedLng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41]
                        }),
                        draggable: true  // Make it draggable!
                    }).addTo(map);

                    // Update coordinates when user drags the pin
                    deliveryMarker.on('dragend', function(e) {
                        const pos = e.target.getLatLng();
                        selectedLat = pos.lat;
                        selectedLng = pos.lng;

                        document.getElementById('addressDisplay').textContent =
                            `üìç ${selectedAddress} (adjusted)`;

                        console.log('Pin adjusted to:', selectedLat, selectedLng);
                    });

                    deliveryMarker.bindPopup(
                        `<b>${address}</b><br><small>Drag pin to adjust exact location</small>`
                    ).openPopup();

                    // Center map on location
                    map.setView([selectedLat, selectedLng], 16);

                    // Update address display
                    document.getElementById('addressDisplay').textContent =
                        `üìç ${address}`;

                    // Move to step 2
                    document.getElementById('step1').classList.add('hidden');
                    document.getElementById('step2').classList.remove('hidden');

                } else {
                    alert('Address not found: ' + data.error);
                    document.getElementById('addressDisplay').textContent =
                        'Address not found. Try again.';
                }
            })
            .catch(err => {
                alert('Failed to find address: ' + err);
                document.getElementById('addressDisplay').textContent =
                    'Error finding address';
            });
    }

    function backToStep1() {
        // Remove delivery marker
        if (deliveryMarker) {
            map.removeLayer(deliveryMarker);
        }

        // Show step 1
        document.getElementById('step1').classList.remove('hidden');
        document.getElementById('step2').classList.add('hidden');

        // Reset view
        map.setView([55.9445, -3.1892], 14);
        document.getElementById('addressDisplay').textContent =
            'Enter your address above';
    }

    function placeOrder() {
        const medicationId = document.getElementById('medication').value;
        const quantity = document.getElementById('quantity').value;

        if (!medicationId) {
            alert('Please select a medication');
            return;
        }

        if (!selectedLat || !selectedLng || !selectedAddress) {
            alert('Please enter and confirm your address first');
            return;
        }

        // Show loading state
        document.getElementById('statusMessage').textContent = 'Placing order...';

        // Create order with address AND coordinates
        fetch(`/api/v1/orders/create-with-address?address=${encodeURIComponent(selectedAddress)}&lat=${selectedLat}&lng=${selectedLng}&medicationId=${medicationId}&quantity=${quantity}`, {
            method: 'POST'
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Order created successfully
                    currentOrderNumber = data.orderNumber;

                    // Hide form, show status
                    document.getElementById('orderFormSection').classList.add('hidden');
                    document.getElementById('orderStatusSection').classList.remove('hidden');

                    // Update UI with order details
                    document.getElementById('orderNumber').textContent = data.orderNumber;
                    document.getElementById('statusMessage').textContent =
                        'Order placed! Your drone will be dispatched soon...';

                    updateStatusBadge('QUEUED');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Failed to place order:', error);
                alert('Failed to place order: ' + error);
            });
    }

    function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
            console.log('WebSocket connected');

            // Subscribe to drone positions
            stompClient.subscribe('/topic/drone/position', function(message) {
                const position = JSON.parse(message.body);
                updateDronePosition(position);
            });
        });
    }

    function updateDronePosition(position) {
        // Only update if this is our order
        if (position.orderNumber !== currentOrderNumber) {
            return;
        }

        // Create or update drone marker
        if (!droneMarker) {
            droneMarker = L.marker([position.lat, position.lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                })
            }).addTo(map);
        }

        droneMarker.setLatLng([position.lat, position.lng]);

        // Update progress bar
        if (position.percentComplete) {
            document.getElementById('progressBar').style.width = position.percentComplete + '%';
        }

        // Update status
        updateStatusBadge(position.status);

        // Pan to drone
        map.panTo([position.lat, position.lng]);
    }

    function updateStatusBadge(status) {
        const badge = document.getElementById('statusBadge');
        badge.textContent = status.replace('_', ' ');
        badge.className = 'status-badge status-' + status.toLowerCase().replace('_', '-');

        // Show confirm pickup when arrived
        if (status === 'ARRIVED') {
            document.getElementById('confirmPickupSection').classList.remove('hidden');
            document.getElementById('statusMessage').textContent =
                'üéâ Your medication has arrived! Please confirm pickup.';
        }
    }

    function confirmPickup() {
        if (!currentOrderNumber) {
            alert('Error: No active order');
            return;
        }

        fetch('/api/v1/orders/confirm-pickup-by-order?orderNumber=' + currentOrderNumber, {
            method: 'POST'
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Pickup confirmed! Drone returning to base.');
                    document.getElementById('confirmPickupSection').classList.add('hidden');
                    updateStatusBadge('COLLECTED');
                    document.getElementById('statusMessage').textContent =
                        'Pickup confirmed. Drone returning to base.';
                } else {
                    alert('‚ùå ' + data.error);
                }
            });
    }

    function resetOrder() {
        // Reset everything
        document.getElementById('orderFormSection').classList.remove('hidden');
        document.getElementById('orderStatusSection').classList.add('hidden');
        document.getElementById('step1').classList.remove('hidden');
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('address').value = '';
        document.getElementById('quantity').value = 1;
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('addressDisplay').textContent = 'Enter your address above';

        currentOrderNumber = null;
        selectedLat = null;
        selectedLng = null;
        selectedAddress = null;

        // Clear markers
        if (droneMarker) map.removeLayer(droneMarker);
        if (deliveryMarker) map.removeLayer(deliveryMarker);
        if (servicePointMarker) map.removeLayer(servicePointMarker);
        if (flightPathLine) map.removeLayer(flightPathLine);

        droneMarker = null;
        deliveryMarker = null;

        // Reset map view
        map.setView([55.9445, -3.1892], 14);
    }
</script>
</body>
</html>